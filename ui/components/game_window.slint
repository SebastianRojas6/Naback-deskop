import { Enemy } from "enemy.slint";
import { MainCharacter } from "main_character.slint";

export component Game_window inherits Rectangle {
    in-out property <int> score: 0;
    in-out property <int> time: 0;

    in property <length> available_width;
    in property <float> scale: 1.0;
    in-out property <int> enemy_count: 0;

    property <bool> is_jumping: false;
    property <int> frame: 0;
    property <bool> jump_triggered: false;
    in-out property <bool> game_over: false;

    property <length> ground_y: 480px * 0.55;
    property <length> jump_y: 480px * 0.05;

    in-out property <float> main_char_x;
    in-out property <float> main_char_y;
    in-out property <float> main_char_w;
    in-out property <float> main_char_h;

    in-out property <[float]> enemy_positions: [];

    callback set_enemy_positions(pos: [float]);
    
    set_enemy_positions(pos) => {
        root.enemy_positions = pos;
    }

    callback spawn_enemy();

    VerticalLayout {
        alignment: center;

        HorizontalLayout {
            alignment: center;
            Rectangle {
                border-color: black;
                border-width: 2px * scale;
                background: #D9D9D9;
                width: Math.min(1290px * scale, available_width);
                border-radius: 10px * scale;
                height: 480px * scale;
                clip: true;

                HorizontalLayout {
                    padding: 20px * scale;
                    spacing: 12px * scale;
                    alignment: space-between;

                    Text {
                        text: "Score: \{score}";
                        color: #37383F;
                        font-family: "Minecraft";
                        font-size: 20px * scale;
                    }

                    Text {
                        text: "Timer: \{time}";
                        color: #37383F;
                        font-family: "Minecraft";
                        font-size: 20px * scale;
                    }
                }

                Rectangle {
                    width: parent.width;
                    height: 70%;
                    y: parent.height - self.height;

                    Image {
                        source: @image-url("../../assets/img/background.png");
                        width: parent.width;
                        height: parent.height;
                    }
                }

                Timer {
                    interval: 600ms;
                    running: !root.game_over;
                    triggered => {
                        frame = Math.mod(frame + 1, 2);
                    }
                }

                Text {
                    text: "¡¡Has muerto!!";
                    visible: root.game_over;
                    color: red;
                    font-size: 40px * scale;
                    font-family: "Minecraft";
                    horizontal-alignment: center;
                    vertical-alignment: center;
                    width: parent.width;
                    height: parent.height;
                }

                main_char := MainCharacter {
                    scale: root.scale * 1.2;
                    frame: root.frame;
                    ground_y: root.ground_y;
                    jump_y: root.jump_y;
                    game_over <=> root.game_over;
                    is_jumping <=> root.is_jumping;
                    jump_triggered <=> root.jump_triggered;
                }

                for pos in enemy_positions: enemy_item := Enemy {
                    position_x: pos;
                    game_over <=> root.game_over;
                    y: parent.height - self.height * 2;
                    scale: root.scale;
                }
            }
        }
    }
}
